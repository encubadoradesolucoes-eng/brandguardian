{% extends "layout.html" %}

{% block title %}Varredura LIVE | m24 Guardian{% endblock %}

{% block extra_css %}
<style>
    /* Estilo Retro-Moderno "Hacker" Limpo */
    :root {
        --terminal-bg: #0f172a;
        --terminal-text: #334155;
        --accent: #0ea5e9;
    }

    .scan-container {
        min-height: 80vh;
        background: #000;
        font-family: 'Courier New', Courier, monospace;
        color: #e2e8f0;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(14, 165, 233, 0.2);
        position: relative;
        overflow: hidden;
    }

    /* Linhas de grade sutis */
    .scan-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
        background-size: 100% 2px, 3px 100%;
        pointer-events: none;
        z-index: 1;
    }

    .terminal-header {
        border-bottom: 1px solid #334155;
        padding-bottom: 15px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 2;
        position: relative;
    }

    .terminal-body {
        height: 60vh;
        overflow-y: auto;
        padding-right: 10px;
        z-index: 2;
        position: relative;
    }

    /* Scrollbar */
    .terminal-body::-webkit-scrollbar {
        width: 8px;
    }

    .terminal-body::-webkit-scrollbar-track {
        background: #1e293b;
    }

    .terminal-body::-webkit-scrollbar-thumb {
        background: #475569;
        border-radius: 4px;
    }

    .input-line {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
        border-top: 1px solid #334155;
        padding-top: 15px;
        z-index: 2;
        position: relative;
    }

    .scan-input {
        background: transparent;
        border: none;
        color: #fff;
        font-family: inherit;
        font-size: 1.1rem;
        flex-grow: 1;
        outline: none;
    }

    .scan-btn {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 8px 20px;
        font-family: inherit;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }

    .scan-btn:hover {
        background: #0284c7;
        box-shadow: 0 0 10px var(--accent);
    }

    .scan-btn:disabled {
        background: #64748b;
        cursor: wait;
    }

    /* Log Types */
    .log-line {
        margin-bottom: 8px;
        font-size: 0.95rem;
        line-height: 1.4;
        border-left: 3px solid transparent;
        padding-left: 10px;
    }

    .log-line.info {
        color: #94a3b8;
        border-color: #475569;
    }

    .log-line.success {
        color: #4ade80;
        border-color: #22c55e;
        background: rgba(34, 197, 94, 0.05);
    }

    .log-line.warning {
        color: #facc15;
        border-color: #eab308;
        background: rgba(234, 179, 8, 0.05);
    }

    .log-line.danger {
        color: #f87171;
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }

    /* Mode Toggle */
    .mode-btn {
        background: transparent;
        border: 1px solid #334155;
        color: #94a3b8;
        padding: 5px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-family: inherit;
        font-size: 0.8rem;
        transition: all 0.3s;
    }

    .mode-btn.active {
        background: #38bdf8;
        color: #0f172a;
        border-color: #38bdf8;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="scan-container">
            <div class="terminal-header">
                <div>
                    <i class="ri-terminal-box-fill"></i> M24 GUARDIAN PROTOCOL <span class="badge bg-danger">LIVE</span>
                </div>
                <div class="text-muted small">v6.0.0 (Build 2026)</div>
            </div>

            <div class="terminal-body" id="terminal">
                <div class="log-line info">Bem-vindo ao m24 Guardian Protocol v6.0</div>
                <div class="log-line info">Sistema pronto. Escolha o modo de opera√ß√£o.</div>
                <br>

                <!-- Mode Toggle -->
                <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <button onclick="setMode('text')" id="btnText" class="mode-btn active">PESQUISA TEXTO
                        (COMPLETA)</button>
                    <a href="{{ url_for('visual_check_page') }}" class="mode-btn"
                        style="text-decoration:none; display:inline-block;">VARREDURA VISUAL (OCR IA)</a>
                </div>

                <div id="scanLogs"></div>
            </div>

            <!-- Input Area -->
            <div id="textInputArea" class="input-line">
                <span style="color: #10b981;">root@m24:~$</span>
                <input type="text" id="brandInput" class="scan-input" placeholder="Digite nome da marca..." autofocus>
                <button onclick="startScan()" class="scan-btn">EXECUTAR</button>
            </div>
        </div>
    </div>
</div>

<script>
    const logs = document.getElementById('scanLogs');
    const input = document.getElementById('brandInput');

    function log(msg, type = 'info') {
        const div = document.createElement('div');
        div.className = 'log-line ' + type;
        div.innerText = msg;
        logs.appendChild(div);

        // Auto scroll
        const term = document.getElementById('terminal');
        term.scrollTop = term.scrollHeight;
    }

    function wait(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    function setMode(mode) {
        if (mode === 'text') {
            document.getElementById('btnText').classList.add('active');
            input.focus();
        }
    }

    input.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') startScan();
    });

    async function startScan() {
        const term = input.value.trim();
        if (!term) return;

        // Limpar e bloquear
        logs.innerHTML = '';
        input.disabled = true;
        document.querySelector('.scan-btn').disabled = true;
        document.querySelector('.scan-btn').innerText = 'VARRENDO...';

        log(`> Iniciando protocolo REAL de varredura para: "${term}"...`, 'info');
        await wait(500);

        try {
            const response = await fetch('/api/scan-live-real', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ termo: term })
            });
            
            // Check if response is OK
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const data = await response.json();
            
            // Debug: log full response
            console.log('[DEBUG] Full API Response:', data);

            if (data.status !== 'sucesso') {
                throw new Error(data.mensagem || 'Erro desconhecido');
            }

            const res = data.resultados;
            
            // Debug: log results structure
            console.log('[DEBUG] Resultados:', res);

            if (data.debug) {
                log(`[DEBUG] termo="${data.debug.termo}" bpi_count=${data.debug.bpi_count} sql_count=${data.debug.sql_count ?? 'n/a'}`, 'info');
                if (data.debug.sql_sample && data.debug.sql_sample.length > 0) {
                    data.debug.sql_sample.forEach(r => {
                        log(`[DEBUG] sql_sample: ${r.brand_name} (Proc: ${r.process_number})`, 'info');
                    });
                }
                if (data.debug.limites && data.debug.limites.length > 0) {
                    data.debug.limites.forEach(l => {
                        log(`[DEBUG] limite: ${l}`, 'info');
                    });
                }
                if (data.debug.debug_error) {
                    log(`[DEBUG] error: ${data.debug.debug_error}`, 'danger');
                }
            }

            // 1. Dom√≠nios
            log(`> [WEB] Verificando disponibilidade de dom√≠nios...`, 'info');
            await wait(600);

            let dominiosOcupados = 0;
            if (res.dominios && res.dominios.length > 0) {
                res.dominios.forEach(d => {
                    if (d.status === 'OCUPADO') {
                        dominiosOcupados++;
                        log(`[WEB] ‚ùå Indispon√≠vel: ${d.dominio}`, 'danger');
                    } else if (d.status === 'DISPON√çVEL') {
                        log(`[WEB] ‚úÖ Dispon√≠vel: ${d.dominio}`, 'success');
                    }
                });
            }

            if (dominiosOcupados === 0) log(`[WEB] Dom√≠nios principais parecem livres.`, 'success');

            // 2. BPI Local
            log(`> [BPI] Consultando base oficial...`, 'info');
            await wait(800);

            // Para usu√°rios logados: res.bpi √© array
            // Para n√£o logados: res.resumo_bpi √© string
            if (res.bpi && res.bpi.length > 0) {
                log(`[!] [BPI] ALERTA: ${res.bpi.length} registro(s) similar(es) encontrado(s):`, 'danger');
                res.bpi.forEach(b => {
                    log(`   -> [${b.similaridade}%] ${b.marca} (Proc: ${b.processo})`, 'warning');
                });
            } else if (res.resumo_bpi) {
                // Usu√°rio n√£o logado - mostra resumo
                const temConflitos = res.resumo_bpi.includes('marcas similares encontradas') && 
                                     !res.resumo_bpi.startsWith('0 marcas');
                if (temConflitos) {
                    log(`[!] [BPI] ALERTA: ${res.resumo_bpi}`, 'danger');
                    log(`     Fa√ßa login para ver detalhes completos.`, 'info');
                } else {
                    log(`[‚úì] [BPI] ${res.resumo_bpi}`, 'success');
                }
            } else {
                log(`[‚úì] [BPI] Nenhuma similaridade direta encontrada na base local.`, 'success');
            }

            // 3. Redes Sociais
            log(`> [SOCIAL] Consultando presen√ßa digital...`, 'info');
            await wait(800);

            if (res.redes_sociais && res.redes_sociais.length > 0) {
                res.redes_sociais.forEach(r => {
                    let icon = r.status === 'OCUPADO' ? '‚ùå' : '‚úÖ';
                    let estilo = r.status === 'OCUPADO' ? 'warning' : 'success';
                    log(`[SOCIAL] ${icon} ${r.plataforma}: ${r.status}`, estilo);
                });
            }

            // 4. Conclus√£o
            log(`----------------------------------------`, 'info');
            if (res.analise_risco) {
                let nivel = res.analise_risco.nivel_risco;
                let classeRisco = nivel === 'ALTO' || nivel === 'CR√çTICO' ? 'danger' : 
                                  nivel === 'M√âDIO' || nivel === 'MODERADO' ? 'warning' : 'success';
                log(`> CONCLUS√ÉO: RISCO ${nivel}`, classeRisco);
                log(`  ${res.analise_risco.recomendacao}`, 'info');
            }

            if (data.mensagem_login) {
                log(`\n[üîí] ${data.mensagem_login}`, 'info');
                log(`     Fa√ßa login para ver detalhes completos e relat√≥rio jur√≠dico.`, 'info');
            }

            log(`> VARREDURA CONCLU√çDA.`, 'success');

        } catch (e) {
            console.error('[ERROR] Scan failed:', e);
            log(`[ERRO CR√çTICO] Falha na an√°lise: ${e.message}`, 'danger');
            log(`Detalhes t√©cnicos: ${e.stack || 'N/A'}`, 'danger');
        }

        // Reabilitar
        input.disabled = false;
        input.focus();
        document.querySelector('.scan-btn').disabled = false;
        document.querySelector('.scan-btn').innerText = 'EXECUTAR';
    }
</script>
{% endblock %}