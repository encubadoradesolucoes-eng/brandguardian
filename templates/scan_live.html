{% extends "layout.html" %}

{% block title %}Varredura LIVE | m24 Guardian{% endblock %}

{% block extra_css %}
<style>
    /* Background da landing page em toda a p√°gina */
    body {
        background: linear-gradient(to right, rgba(2, 6, 23, 0.9) 0%, rgba(2, 6, 23, 0.6) 100%), url('/static/hero-guardian.png') !important;
        background-size: cover !important;
        background-position: center !important;
        background-attachment: fixed !important;
    }

    /* Estilo Retro-Moderno "Hacker" Limpo */
    :root {
        --terminal-bg: #0f172a;
        --terminal-text: #334155;
        --accent: #0ea5e9;
    }

    .scan-container {
        min-height: 80vh;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(10px);
        font-family: 'Courier New', Courier, monospace;
        color: #e2e8f0;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(14, 165, 233, 0.2);
        position: relative;
        overflow: hidden;
    }

    /* Linhas de grade sutis - mant√©m o efeito terminal */
    .scan-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
        background-size: 100% 2px, 3px 100%;
        pointer-events: none;
        z-index: 1;
    }

    .terminal-header {
        border-bottom: 1px solid #334155;
        padding-bottom: 15px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 2;
        position: relative;
    }

    .terminal-body {
        height: 60vh;
        overflow-y: auto;
        padding-right: 10px;
        z-index: 2;
        position: relative;
    }

    /* Scrollbar */
    .terminal-body::-webkit-scrollbar {
        width: 8px;
    }

    .terminal-body::-webkit-scrollbar-track {
        background: #1e293b;
    }

    .terminal-body::-webkit-scrollbar-thumb {
        background: #475569;
        border-radius: 4px;
    }

    .input-line {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
        border-top: 1px solid #334155;
        padding-top: 15px;
        z-index: 2;
        position: relative;
    }

    .scan-input {
        background: transparent;
        border: none;
        color: #fff;
        font-family: inherit;
        font-size: 1.1rem;
        flex-grow: 1;
        outline: none;
    }

    .scan-btn {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 8px 20px;
        font-family: inherit;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }

    .scan-btn:hover {
        background: #0284c7;
        box-shadow: 0 0 10px var(--accent);
    }

    .scan-btn:disabled {
        background: #64748b;
        cursor: wait;
    }

    /* Log Types */
    .log-line {
        margin-bottom: 8px;
        font-size: 0.95rem;
        line-height: 1.4;
        border-left: 3px solid transparent;
        padding-left: 10px;
    }

    .log-line.info {
        color: #94a3b8;
        border-color: #475569;
    }

    .log-line.success {
        color: #4ade80;
        border-color: #22c55e;
        background: rgba(34, 197, 94, 0.05);
    }

    .log-line.warning {
        color: #facc15;
        border-color: #eab308;
        background: rgba(234, 179, 8, 0.05);
    }

    .log-line.danger {
        color: #f87171;
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }

    /* Estilo especial para alertas BPI cr√≠ticos */
    .log-line.bpi-alert {
        background: white !important;
        color: #dc2626 !important;
        border: 3px solid #dc2626 !important;
        border-left-width: 8px !important;
        font-size: 1.2rem !important;
        font-weight: 700 !important;
        padding: 16px 20px !important;
        margin: 12px 0 !important;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(220, 38, 38, 0.3);
        animation: pulse-alert 2s ease-in-out infinite;
    }

    @keyframes pulse-alert {
        0%, 100% { box-shadow: 0 4px 20px rgba(220, 38, 38, 0.3); }
        50% { box-shadow: 0 4px 30px rgba(220, 38, 38, 0.6); }
    }

    /* Mode Toggle */
    .mode-btn {
        background: transparent;
        border: 1px solid #334155;
        color: #94a3b8;
        padding: 5px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-family: inherit;
        font-size: 0.8rem;
        transition: all 0.3s;
    }

    .mode-btn.active {
        background: #38bdf8;
        color: #0f172a;
        border-color: #38bdf8;
        font-weight: bold;
    }

    /* Sidebar Comercial */
    .commercial-sidebar {
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
    }

    .cta-card {
        background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .cta-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #6366f1, #8b5cf6);
    }

    .cta-card:hover {
        transform: translateY(-5px);
        border-color: rgba(99, 102, 241, 0.6);
        box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
    }

    .cta-card h4 {
        font-family: 'Outfit', sans-serif;
        font-size: 1.1rem;
        font-weight: 700;
        color: white;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .cta-card h4 i {
        color: #6366f1;
        font-size: 1.3rem;
    }

    .cta-card p {
        color: #cbd5e1;
        font-size: 0.9rem;
        line-height: 1.5;
        margin-bottom: 16px;
    }

    .cta-btn {
        display: block;
        width: 100%;
        padding: 12px 20px;
        background: #6366f1;
        color: white;
        text-align: center;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s;
        border: 1px solid #6366f1;
    }

    .cta-btn:hover {
        background: #4f46e5;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
        color: white;
    }

    .cta-btn.secondary {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
    }

    .cta-btn.secondary:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: white;
    }

    .cta-badge {
        display: inline-block;
        padding: 4px 10px;
        background: rgba(99, 102, 241, 0.2);
        color: #818cf8;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 700;
        margin-bottom: 12px;
        border: 1px solid rgba(99, 102, 241, 0.3);
    }

    /* Scrollbar customizada para sidebar */
    .commercial-sidebar::-webkit-scrollbar {
        width: 6px;
    }

    .commercial-sidebar::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
    }

    .commercial-sidebar::-webkit-scrollbar-thumb {
        background: rgba(99, 102, 241, 0.5);
        border-radius: 10px;
    }

    .commercial-sidebar::-webkit-scrollbar-thumb:hover {
        background: rgba(99, 102, 241, 0.7);
    }
</style>
{% endblock %}

{% block content %}

<div class="row">
    <!-- Terminal Principal -->
    <div class="col-lg-8">
        <div class="scan-container">
            <div class="terminal-header">
                <div>
                    <i class="ri-terminal-box-fill"></i> M24 GUARDIAN PROTOCOL <span class="badge bg-danger">LIVE</span>
                </div>
                <div class="text-muted small">v6.0.0 (Build 2026)</div>
            </div>

            <div class="terminal-body" id="terminal">
                <div class="log-line info">Bem-vindo ao m24 Guardian Protocol v6.0</div>
                <div class="log-line info">Sistema pronto. Escolha o modo de opera√ß√£o.</div>
                <br>

                <!-- Mode Toggle -->
                <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <button onclick="setMode('text')" id="btnText" class="mode-btn active">PESQUISA TEXTO
                        (COMPLETA)</button>
                    <a href="{{ url_for('visual_check_page') }}" class="mode-btn"
                        style="text-decoration:none; display:inline-block;">VARREDURA VISUAL (OCR IA)</a>
                </div>

                <div id="scanLogs"></div>
            </div>

            <!-- Input Area -->
            <div id="textInputArea" class="input-line">
                <span style="color: #10b981;">root@m24:~$</span>
                <input type="text" id="brandInput" class="scan-input" placeholder="Digite nome da marca..." autofocus>
                <button onclick="startScan()" class="scan-btn">EXECUTAR</button>
            </div>
        </div>
    </div>
</div>

<script>
    const logs = document.getElementById('scanLogs');
    const input = document.getElementById('brandInput');

    function log(msg, type = 'info', isHtml = false) {
        const div = document.createElement('div');
        div.className = 'log-line ' + type;
        
        if (isHtml) {
            div.innerHTML = msg;
        } else {
            div.innerText = msg;
        }
        
        logs.appendChild(div);

        // Auto scroll
        const term = document.getElementById('terminal');
        term.scrollTop = term.scrollHeight;
    }

    function wait(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    function setMode(mode) {
        if (mode === 'text') {
            document.getElementById('btnText').classList.add('active');
            input.focus();
        }
    }

    input.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') startScan();
    });

    async function startScan() {
        const term = input.value.trim();
        if (!term) return;

        // Limpar e bloquear
        logs.innerHTML = '';
        input.disabled = true;
        document.querySelector('.scan-btn').disabled = true;
        document.querySelector('.scan-btn').innerText = 'VARRENDO...';

        log(`> Iniciando protocolo REAL de varredura para: "${term}"...`, 'info');
        await wait(500);

        try {
            const response = await fetch('/api/scan-live-real', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ termo: term })
            });
            
            // Check if response is OK
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const data = await response.json();
            
            // Debug: log full response
            console.log('[DEBUG] Full API Response:', data);

            if (data.status !== 'sucesso') {
                throw new Error(data.mensagem || 'Erro desconhecido');
            }

            const res = data.resultados;
            
            // Debug: log results structure
            console.log('[DEBUG] Resultados:', res);

            if (data.debug) {
                log(`[DEBUG] termo="${data.debug.termo}" bpi_count=${data.debug.bpi_count} sql_count=${data.debug.sql_count ?? 'n/a'}`, 'info');
                if (data.debug.sql_sample && data.debug.sql_sample.length > 0) {
                    data.debug.sql_sample.forEach(r => {
                        log(`[DEBUG] sql_sample: ${r.brand_name} (Proc: ${r.process_number})`, 'info');
                    });
                }
                if (data.debug.limites && data.debug.limites.length > 0) {
                    data.debug.limites.forEach(l => {
                        log(`[DEBUG] limite: ${l}`, 'info');
                    });
                }
                if (data.debug.debug_error) {
                    log(`[DEBUG] error: ${data.debug.debug_error}`, 'danger');
                }
            }

            // 1. Dom√≠nios
            log(`> [WEB] Verificando disponibilidade de dom√≠nios...`, 'info');
            await wait(600);

            let dominiosOcupados = 0;
            if (res.dominios && res.dominios.length > 0) {
                res.dominios.forEach(d => {
                    if (d.status === 'OCUPADO') {
                        dominiosOcupados++;
                        log(`[WEB] ‚ùå Indispon√≠vel: ${d.dominio}`, 'danger');
                    } else if (d.status === 'DISPON√çVEL') {
                        log(`[WEB] ‚úÖ Dispon√≠vel: ${d.dominio}`, 'success');
                    }
                });
            }

            if (dominiosOcupados === 0) log(`[WEB] Dom√≠nios principais parecem livres.`, 'success');

            // 2. BPI Local
            log(`> [BPI] Consultando base oficial...`, 'info');
            await wait(800);

            // Para usu√°rios logados: res.bpi √© array
            // Para n√£o logados: res.resumo_bpi √© string
            if (res.bpi && res.bpi.length > 0) {
                log(`üö® [BPI] ALERTA: ${res.bpi.length} registro(s) similar(es) encontrado(s)`, 'bpi-alert');
                res.bpi.forEach(b => {
                    log(`   -> [${b.similaridade}%] ${b.marca} (Proc: ${b.processo})`, 'warning');
                });
            } else if (res.resumo_bpi) {
                // Usu√°rio n√£o logado - mostra resumo
                const temConflitos = res.resumo_bpi.includes('marcas similares encontradas') && 
                                     !res.resumo_bpi.startsWith('0 marcas');
                if (temConflitos) {
                    log(`üö® [BPI] ALERTA: ${res.resumo_bpi}`, 'bpi-alert');
                } else {
                    log(`[‚úì] [BPI] ${res.resumo_bpi}`, 'success');
                }
            } else {
                log(`[‚úì] [BPI] Nenhuma similaridade direta encontrada na base local.`, 'success');
            }

            // 3. Redes Sociais
            log(`> [SOCIAL] Consultando presen√ßa digital...`, 'info');
            await wait(800);

            if (res.redes_sociais && res.redes_sociais.length > 0) {
                res.redes_sociais.forEach(r => {
                    let icon = r.status === 'OCUPADO' ? '‚ùå' : '‚úÖ';
                    let estilo = r.status === 'OCUPADO' ? 'warning' : 'success';
                    log(`[SOCIAL] ${icon} ${r.plataforma}: ${r.status}`, estilo);
                });
            }

            // 4. Conclus√£o
            log(`----------------------------------------`, 'info');
            if (res.analise_risco) {
                let nivel = res.analise_risco.nivel_risco;
                let classeRisco = nivel === 'ALTO' || nivel === 'CR√çTICO' ? 'danger' : 
                                  nivel === 'M√âDIO' || nivel === 'MODERADO' ? 'warning' : 'success';
                log(`> CONCLUS√ÉO: RISCO ${nivel}`, classeRisco);
                log(`  ${res.analise_risco.recomendacao}`, 'info');
            }

            // 5. Mensagem Comercial (se n√£o logado)
            if (res.mensagem_comercial) {
                const msg = res.mensagem_comercial;
                log(`\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`, 'info');
                log(`${msg.titulo}`, 'warning');
                log(`${msg.texto}`, 'info');
                log(``, 'info');
                
                // Lista de benef√≠cios
                msg.beneficios.forEach(beneficio => {
                    log(`  ${beneficio}`, 'success');
                });
                
                log(``, 'info');
                
                // CTAs com bot√µes clic√°veis - cores da landing page
                const ctaHtml = `
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <a href="/login" style="
                            background: #6366f1;
                            color: white;
                            padding: 10px 20px;
                            border-radius: 6px;
                            text-decoration: none;
                            font-weight: bold;
                            display: inline-block;
                            transition: all 0.3s;
                            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.background='#4f46e5'" onmouseout="this.style.transform='translateY(0)'; this.style.background='#6366f1'">
                            üîì ${msg.cta_login}
                        </a>
                        <a href="/pricing" style="
                            background: #8b5cf6;
                            color: white;
                            padding: 10px 20px;
                            border-radius: 6px;
                            text-decoration: none;
                            font-weight: bold;
                            display: inline-block;
                            transition: all 0.3s;
                            box-shadow: 0 10px 20px -5px rgba(139, 92, 246, 0.4);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.background='#7c3aed'" onmouseout="this.style.transform='translateY(0)'; this.style.background='#8b5cf6'">
                            üíé ${msg.cta_planos}
                        </a>
                    </div>
                `;
                log(ctaHtml, 'info', true);
                log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`, 'info');
            }

            log(`> VARREDURA CONCLU√çDA.`, 'success');

        } catch (e) {
            console.error('[ERROR] Scan failed:', e);
            log(`[ERRO CR√çTICO] Falha na an√°lise: ${e.message}`, 'danger');
            log(`Detalhes t√©cnicos: ${e.stack || 'N/A'}`, 'danger');
        }

        // Reabilitar
        input.disabled = false;
        input.focus();
        document.querySelector('.scan-btn').disabled = false;
        document.querySelector('.scan-btn').innerText = 'EXECUTAR';
    }
</script>
        </div>
    </div><!-- Fim col-lg-8 -->

    <!-- Sidebar Visual com Cards Grandes -->
    <div class="col-lg-4">
        <div class="commercial-sidebar">
            
            <!-- Card: Planos Premium -->
            <div class="cta-card" style="text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 16px;">
                    <i class="ri-vip-crown-fill" style="color: #fbbf24;"></i>
                </div>
                <h4 style="font-size: 1.4rem; margin-bottom: 12px;">Planos Premium</h4>
                <p style="margin-bottom: 20px;">Proteja at√© 100 marcas com monitoramento 24/7 e relat√≥rios profissionais.</p>
                <a href="/pricing" class="cta-btn">Ver Planos e Pre√ßos</a>
            </div>

            <!-- Card: Cadastro Gr√°tis -->
            <div class="cta-card" style="text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 16px;">
                    <i class="ri-rocket-fill" style="color: #10b981;"></i>
                </div>
                <h4 style="font-size: 1.4rem; margin-bottom: 12px;">Comece Gr√°tis</h4>
                <p style="margin-bottom: 20px;">Crie sua conta e monitore 5 marcas gratuitamente. Sem cart√£o de cr√©dito.</p>
                <a href="/register" class="cta-btn">Criar Conta Agora</a>
            </div>

            <!-- Card: Agentes PI -->
            <div class="cta-card" style="text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 16px;">
                    <i class="ri-briefcase-4-fill" style="color: #8b5cf6;"></i>
                </div>
                <h4 style="font-size: 1.4rem; margin-bottom: 12px;">Agentes de PI</h4>
                <p style="margin-bottom: 20px;">Dashboard profissional, prospector de oportunidades e relat√≥rios white-label.</p>
                <a href="/signup?role=agent&plan=agent_pro" class="cta-btn secondary">Plano para Agentes</a>
            </div>

            <!-- Card: Cursos -->
            <div class="cta-card" style="text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 16px;">
                    <i class="ri-book-open-fill" style="color: #3b82f6;"></i>
                </div>
                <h4 style="font-size: 1.4rem; margin-bottom: 12px;">Cursos de PI</h4>
                <p style="margin-bottom: 20px;">Aprenda estrat√©gias avan√ßadas de prote√ß√£o e gest√£o de propriedade industrial.</p>
                <a href="#" class="cta-btn secondary" onclick="alert('Em breve! Cursos especializados.'); return false;">Em Breve</a>
            </div>

        </div>
    </div><!-- Fim Sidebar -->

</div><!-- Fim row -->
{% endblock %}