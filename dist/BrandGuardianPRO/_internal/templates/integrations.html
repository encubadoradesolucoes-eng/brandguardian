{% extends "layout.html" %}

{% block content %}
<div class="main-content" style="padding: 2rem; max-width: 1200px; margin: 0 auto;">
    
    <div style="margin-bottom: 2rem;">
        <h2 class="section-title" style="font-size: 2rem; margin-bottom: 0.5rem;">Integrações & API</h2>
        <p style="color: #64748b;">Gerencie conexões externas (WhatsApp, Email, IPI Gateway).</p>
    </div>

    <div class="settings-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 2rem;">

        <!-- Email & System Logs Config -->
        <div class="card">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom: 20px;">
                <i class="ri-mail-check-fill" style="color: var(--brand-primary); font-size: 2rem;"></i>
                <div>
                    <h3 style="margin:0;">Status do Servidor de Email</h3>
                    <div style="font-size: 0.8rem; color:#64748b;">Acompanhamento de comunicações automáticas.</div>
                </div>
            </div>

            <!-- Email Activity Log -->
            <div style="background: rgba(0,0,0,0.1); border-radius: 12px; border: 1px solid var(--border-subtle); overflow: hidden;">
                <div style="padding: 10px 15px; background: rgba(255,255,255,0.02); font-size: 0.7rem; font-weight: 800; color: var(--text-dim); text-transform: uppercase; border-bottom: 1px solid var(--border-subtle);">
                    Últimos Registros de Envio
                </div>
                <div style="max-height: 250px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                        <tbody id="email-log-body">
                            {% if email_logs %}
                                {% for log in email_logs %}
                                <tr>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid var(--border-subtle);">
                                        <div style="font-weight: 700; color: white;">{{ log.recipient }}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-dim);">{{ log.subject }}</div>
                                    </td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid var(--border-subtle);">
                                        {% if log.status == 'sent' %}
                                            <span class="status-pill success" style="padding: 2px 8px; font-size: 0.65rem;">ENVIADO</span>
                                        {% else %}
                                            <span class="status-pill danger" style="padding: 2px 8px; font-size: 0.65rem;" title="{{ log.error_message }}">ERRO</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 12px 15px; border-bottom: 1px solid var(--border-subtle); text-align: right; color: var(--text-dim); font-size: 0.7rem;">
                                        {{ log.timestamp.strftime('%H:%M - %d/%m') }}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="3" style="padding: 40px; text-align: center; color: var(--text-dim);">
                                        Nenhum registro de email encontrado.
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Quick Email Reset/Fix -->
            <div style="margin-top: 20px; padding: 15px; background: rgba(99, 102, 241, 0.05); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 12px;">
                <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: white;">Verificação Rápida de SMTP</h4>
                <p style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 15px;">Se os emails não chegarem, verifique se a porta 587 está aberta no firewall.</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-m24" style="background: var(--bg-elevated); padding: 8px 15px; font-size: 0.85rem; border: 1px solid var(--border-subtle); color: white;">
                        Re-iniciar Servidor
                    </button>
                    <button class="btn-m24" style="background: var(--brand-primary); padding: 8px 15px; font-size: 0.85rem; border: none; color: white;">
                        Enviar Teste de Conexão
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const qrSection = document.getElementById('qr-section');
    const connectedSection = document.getElementById('connected-section');
    const qrImage = document.getElementById('qr-image');
    const qrLoader = document.getElementById('qr-loader');
    const connectionStatus = document.getElementById('connection-status');
    const waSwitch = document.getElementById('wa-switch');
    let isConnectedGlobal = false;

    function updateUI(status, qrCode) {
        // Atualizar Label Superior
        if (status === 'CONNECTED') {
            isConnectedGlobal = true;
            connectionStatus.innerHTML = '<span style="color:#25D366">● Online</span>';
            if(waSwitch) waSwitch.checked = true;
            
            qrSection.style.display = 'none';
            connectedSection.style.display = 'block';
        } else {
            isConnectedGlobal = false;
            connectionStatus.innerHTML = '<span style="color:#f59e0b">● Aguardando Conexão...</span>';
            if(waSwitch) waSwitch.checked = false;
            
            qrSection.style.display = 'block';
            connectedSection.style.display = 'none';
            
            if (status === 'QR_CODE' && qrCode) {
                qrImage.src = qrCode;
                qrImage.style.display = 'block';
                qrLoader.style.display = 'none';
            } else {
                qrImage.style.display = 'none';
                qrLoader.style.display = 'flex';
            }
        }
    }

    async function pollStatus() {
        // Se já está conectado, reduzir polling para economizar recurso, mas continuar checando caso caia
        try {
            const response = await fetch('/api/whatsapp/status');
            const data = await response.json();
            updateUI(data.status, data.qr_code);
        } catch (e) {
            console.error("Erro polling:", e);
        }
    }

    async function sendTestMessage(type) {
        const phone = document.getElementById('test-phone').value;
        const resDiv = document.getElementById('test-result');
        
        if(!phone) { 
            resDiv.innerHTML = '<span style="color:#f59e0b">⚠️ Digite um número de destino.</span>';
            return; 
        }
        
        resDiv.innerHTML = '<span style="color:#cbd5e1"><i class="ri-loader-4-line ri-spin"></i> Enviando...</span>';
        
        const msg = type === 'card' 
            ? "Olá!\nObrigado por receber o nosso cartão de visitas.\nA M24 é uma plataforma dedicada à gestão e monitorização de marcas e direitos de propriedade industrial." 
            : "Olá, esta é uma mensagem de testes da plataforma M24.";

        try {
            const response = await fetch('/api/send-whatsapp', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    target_phone: phone, 
                    message: msg,
                    type: type 
                })
            });
            const data = await response.json();
            
            if(data.status === 'success') {
                resDiv.innerHTML = '<span style="color:#25D366">✅ Sucesso! Verifique seu WhatsApp/Celular.</span>';
            } else {
                resDiv.innerHTML = '<span style="color:#ef4444">❌ Erro: ' + (data.details || 'Falha desconhecida') + '</span>';
            }
        } catch (e) {
            resDiv.innerHTML = '<span style="color:#ef4444">❌ Falha de Conexão com Servidor Interno.</span>';
        }
    }

    // Poll a cada 3 segundos
    setInterval(pollStatus, 3000);
    setTimeout(pollStatus, 500); // Primeira checagem rápida
</script>

<style>
/* ... existing styles ... */
</style>
{% endblock %}
