{% extends "layout.html" %}

{% block title %}Inteligência de Conflito | m24 Pro{% endblock %}

{% block extra_css %}
<style>
    .analyze-hero {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-3xl);
        padding: 3rem;
        margin-bottom: 3rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .risk-radial {
        width: 180px;
        height: 180px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .risk-radial svg {
        transform: rotate(-90deg);
        width: 100%;
        height: 100%;
    }

    .risk-radial circle {
        fill: none;
        stroke-width: 10;
        stroke-linecap: round;
    }

    .risk-radial .bg { stroke: var(--border-subtle); }
    .risk-radial .fill { 
        stroke: {% if brand.risk_level == 'high' %}var(--danger){% else %}var(--success){% endif %};
        stroke-dasharray: 283;
        stroke-dashoffset: {{ 283 - (283 * brand.risk_score / 100) }};
        transition: stroke-dashoffset 2s var(--cubic-standard);
        filter: drop-shadow(0 0 8px {% if brand.risk_level == 'high' %}var(--danger){% else %}var(--success){% endif %});
    }

    .analysis-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 6px;
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-2xl);
        width: fit-content;
    }

    .tab-btn {
        padding: 10px 24px;
        border-radius: var(--radius-xl);
        border: none;
        background: none;
        color: var(--text-dim);
        font-weight: 700;
        cursor: pointer;
        transition: var(--transition-elite);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .tab-btn.active {
        background: var(--bg-elevated);
        color: var(--text-vibrant);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    /* Conflict Cards */
    .conflict-card {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
        padding: 2rem;
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-2xl);
        position: relative;
        transition: var(--transition-elite);
    }

    .conflict-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 20%;
        height: 60%;
        width: 4px;
        border-radius: 0 4px 4px 0;
    }

    .conflict-card.high::before { background: var(--danger); }
    .conflict-card.medium::before { background: var(--warning); }
    .conflict-card.low::before { background: var(--success); }

    .conflict-card:hover {
        transform: translateX(10px);
        border-color: var(--brand-primary);
        background: var(--bg-elevated);
    }

    .score-badge {
        font-family: 'JetBrains Mono';
        font-weight: 800;
        background: var(--bg-base);
        padding: 6px 12px;
        border-radius: 8px;
        border: 1px solid var(--border-subtle);
    }

    .web-scan-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
    }

    .web-item {
        padding: 1.5rem;
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-xl);
    }
</style>
{% endblock %}

{% block content %}
<div class="animate-reveal">
    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2.5rem;">
        <div>
            <h1 class="hero-title">Inteligência de Conflito</h1>
            <p class="hero-desc">Mapeamento fonético e visual da marca <strong>{{ brand.name }}</strong>.</p>
        </div>
        <div style="display: flex; gap: 1rem;">
             <button class="btn-m24 btn-m24-ghost"><i class="ri-history-line"></i> Re-executar Scan</button>
             <button class="btn-m24 btn-m24-primary"><i class="ri-file-shield-2-line"></i> Relatório de Oposição</button>
        </div>
    </div>

    <!-- Strategy Hero -->
    <div class="analyze-hero">
        <div style="display: flex; align-items: center; gap: 2.5rem;">
            <div class="brand-viz" style="width: 140px; height: 140px; padding: 1rem; border-radius: var(--radius-2xl);">
                {% if brand.logo_path %}
                <img src="{{ url_for('static', filename='../uploads/' + brand.logo_path) }}">
                {% else %}
                <i class="ri-trademark-fill" style="font-size: 3rem; color: #ccc;"></i>
                {% endif %}
            </div>
            <div>
                <div style="font-size: 0.8rem; font-weight: 800; color: var(--brand-primary); text-transform: uppercase; margin-bottom: 5px;">Score de Vulnerabilidade</div>
                <h2 style="font-family: 'Outfit'; font-size: 2.5rem; color: var(--text-vibrant);">{{ brand.risk_score }}% <span style="font-size: 1rem; color: var(--text-dim); font-weight: 400;">Global Index</span></h2>
                <div style="display: flex; gap: 10px; margin-top: 1rem;">
                    <span class="status-pill {% if brand.risk_level == 'high' %}danger{% else %}success{% endif %}" style="padding: 6px 16px;">{{ brand.risk_level|upper }} IMPACT</span>
                    <span class="status-pill warning" style="padding: 6px 16px;">PRODUTO: {{ brand.nice_classes }}</span>
                </div>
            </div>
        </div>
        
        <div class="risk-radial">
            <svg viewBox="0 0 100 100">
                <circle class="bg" cx="50" cy="50" r="45"></circle>
                <circle class="fill" cx="50" cy="50" r="45"></circle>
            </svg>
            <div style="position: absolute; text-align: center;">
                <div style="font-family: 'Outfit'; font-weight: 900; font-size: 1.8rem; color: var(--text-vibrant);">{{ brand.risk_score }}%</div>
                <div style="font-size: 0.6rem; font-weight: 800; color: var(--text-dim);">RISK SCORE</div>
            </div>
        </div>
    </div>

    <!-- Multi-dimensional Tabs -->
    <div class="analysis-tabs">
        <button class="tab-btn active" onclick="switchSection('similarity')"><i class="ri-bubble-chart-line"></i> Conflitos BPI</button>
        <button class="tab-btn" onclick="switchSection('web')"><i class="ri-global-line"></i> Varredura Digital</button>
        <button class="tab-btn" onclick="switchSection('comparison')"><i class="ri-layout-masonry-line"></i> Análise Comparativa</button>
        <button class="tab-btn" onclick="switchSection('strategy')"><i class="ri-flashlight-line"></i> Plano de Ação</button>
    </div>

    <!-- Section: Similarity -->
    <div id="similarity-sec" class="tab-content">
        <h3 style="font-family: 'Outfit'; margin-bottom: 1.5rem; padding-left: 0.5rem;">Marcas com Similaridade Crítica</h3>
        
        {% for item in similar %}
        <div class="conflict-card {{ item.risk_level }}">
            <div style="width: 80px; height: 80px; background: #fff; border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center; padding: 10px;">
                <i class="ri-trademark-fill" style="font-size: 2rem; color: #eee;"></i>
            </div>
            <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                    <div>
                        <div style="font-weight: 800; font-size: 1.25rem; color: var(--text-vibrant);">{{ item.brand.name }}</div>
                        <div style="font-size: 0.85rem; color: var(--text-dim);">Titular: {{ item.brand.owner_name }}</div>
                    </div>
                    <div class="score-badge" style="color: {% if item.total_risk > 70 %}var(--danger){% else %}var(--warning){% endif %};">
                        {{ item.total_risk }}% MATCH
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div style="background: var(--bg-base); padding: 12px; border-radius: 12px; border: 1px solid var(--border-subtle);">
                        <div style="font-size: 0.65rem; font-weight: 800; color: var(--text-dim);">FONÉTICO</div>
                        <div style="font-size: 1rem; font-weight: 700; color: var(--text-vibrant);">{{ item.text_similarity }}%</div>
                    </div>
                    <div style="background: var(--bg-base); padding: 12px; border-radius: 12px; border: 1px solid var(--border-subtle);">
                        <div style="font-size: 0.65rem; font-weight: 800; color: var(--text-dim);">VISUAL</div>
                        <div style="font-size: 1rem; font-weight: 700; color: var(--text-vibrant);">{{ item.visual_similarity }}%</div>
                    </div>
                    <div style="background: var(--bg-base); padding: 12px; border-radius: 12px; border: 1px solid var(--border-subtle);">
                        <div style="font-size: 0.65rem; font-weight: 800; color: var(--text-dim);">CLASSE NICE</div>
                        <div style="font-size: 1rem; font-weight: 700; color: var(--text-vibrant);">{{ item.class_overlap }}%</div>
                    </div>
                </div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <a href="{{ url_for('brand_detail', brand_id=item.brand.id) }}" class="btn-m24-ghost" style="padding: 10px;"><i class="ri-eye-line"></i></a>
                <button class="btn-m24-primary" style="padding: 10px; background: var(--danger);"><i class="ri-notification-badge-line"></i></button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Section: Web Scan -->
    <div id="web-sec" class="tab-content" style="display: none;">
        <div class="web-scan-grid">
            {% for res in web_results %}
            <div class="web-item">
                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                    <span style="font-size: 0.7rem; font-weight: 800; background: var(--bg-elevated); padding: 4px 10px; border-radius: 6px; color: var(--brand-accent);">{{ res.source|upper }}</span>
                    <i class="ri-external-link-line" style="color: var(--text-dim);"></i>
                </div>
                <h4 style="font-weight: 800; color: var(--text-vibrant); margin-bottom: 8px; font-size: 1rem;">{{ res.title }}</h4>
                <p style="font-size: 0.85rem; color: var(--text-standard); line-height: 1.5; margin-bottom: 1.5rem;">{{ res.snippet }}</p>
                <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-subtle); pt: 1rem;">
                    <span class="status-pill {% if res.relevance == 'high' %}danger{% else %}success{% endif %}" style="font-size: 0.65rem;">RELEVÂNCIA: {{ res.relevance|upper }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    function switchSection(secId) {
        document.querySelectorAll('.tab-content').forEach(s => s.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        const target = document.getElementById(secId + '-sec');
        if (target) target.style.display = 'block';
        
        event.currentTarget.classList.add('active');
    }
</script>
{% endblock %}