{% extends "layout.html" %}

{% block title %}Varredura LIVE | m24 Pro{% endblock %}

{% block extra_css %}
<style>
    /* ... existing styles ... */
    .mode-btn {
        background: transparent;
        border: 1px solid #334155;
        color: #94a3b8;

            {
            % block content %
        }

        <div class="animate-reveal" style="max-width: 900px; margin: 0 auto;"><h1 class="hero-title" style="text-align: center; margin-bottom: 2rem;">Varredura <span style="color: #ef4444;">LIVE</span></h1>< !-- FormulÃ¡rio para submit backend (scan_marca_page) --><form method="post" style="margin-bottom: 2rem; display: flex; gap: 10px; justify-content: center;" autocomplete="off"><input type="text" name="termo" placeholder="Digite o nome da marca para scan..." value="{{ termo|default('') }}" style="padding: 8px 16px; border-radius: 6px; border: 1px solid #334155; min-width: 220px;"><button type="submit" class="scan-btn">SCAN BACKEND</button></form> {
            % if resultado %
        }

        <div style="background: #1e293b; color: #fff; border-radius: 8px; padding: 20px; margin-bottom: 2rem;"><h3>Resultado do Scan (Backend)</h3><pre style="white-space: pre-wrap; word-break: break-all; background: #0f172a; color: #38bdf8; padding: 12px; border-radius: 6px;"> {
                {
                resultado|tojson(indent=2)
            }
        }

        </pre></div> {
            % endif %
        }

        <div class="terminal-window"><div class="terminal-header"><div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div><div style="margin-left: auto; color: #94a3b8; font-size: 0.8rem;">root@m24-guardian: ~</div> </div> <div class="terminal-body" id="terminal" > <div class="log-line" >Bem-vindo ao m24 Guardian Protocol v2.0</div> <div class="log-line" >Sistema pronto. Escolha o modo de operaÃ§Ã£o.</div> <br> < !-- Mode Toggle --> <div style="margin-bottom: 20px; display: flex; gap: 10px;" > <button onclick="setMode('text')" id="btnText" class="mode-btn active" >PESQUISA TEXTO</button> <button onclick="setMode('image')" id="btnImage" class="mode-btn" >VARREDURA VISUAL (LOGO)</button> </div> < !-- Image Preview Area --> <div id="imgPreview" style="display: none; margin-bottom: 20px; transition: all 0.5s;" > <div style="display: inline-block; padding: 5px; border: 1px dashed #334155; border-radius: 8px;" > <img id="previewObj" src="" style="max-height: 100px; display: block;" > </div> </div> < !-- Input Area (Text) --> <div id="textInputArea" class="input-line" > <span style="color: #10b981;" >root@m24: ~$</span> <input type="text" id="brandInput" class="scan-input" placeholder="Digite nome da marca..." autofocus> <button onclick="startScan()" class="scan-btn" >EXECUTAR</button> </div> < !-- Input Area (Image) --> <div id="imageInputArea" class="input-line" style="display:none;" > <span style="color: #f59e0b;" >root@m24: ~$ scan -img</span> <label for="logoUpload" style="cursor: pointer; background: #1e293b; padding: 8px 15px; border: 1px solid #334155; border-radius: 4px; color: #cbd5e1; display: flex; align-items: center; gap: 10px; font-size: 0.9rem;" > <i class="ri-upload-cloud-fill" ></i> Carregar Imagem </label> <input type="file" id="logoUpload" accept="image/*" style="display: none;" onchange="handleImageSelect(this)" > <span id="fileName" style="font-size: 0.9rem; color: #64748b; margin-right: auto;" >Nenhum arquivo</span> <button onclick="startScanImage()" class="scan-btn" id="btnScanImage" disabled>ANALISAR LOGOTIPO</button> </div> <div id="scanLogs" ></div> </div> </div> </div> {
                    % endblock %
                }

                <div id="imageInputArea" class="input-line" style="display:none;"><span style="color: #f59e0b;">root@m24: ~$ scan -img</span> <label for="logoUpload" style="cursor: pointer; background: #1e293b; padding: 8px 15px; border: 1px solid #334155; border-radius: 4px; color: #cbd5e1; display: flex; align-items: center; gap: 10px; font-size: 0.9rem;" > <i class="ri-upload-cloud-fill" ></i> Carregar Imagem </label> <input type="file" id="logoUpload" accept="image/*" style="display: none;" onchange="handleImageSelect(this)" > <span id="fileName" style="font-size: 0.9rem; color: #64748b; margin-right: auto;" >Nenhum arquivo</span> <button onclick="startScanImage()" class="scan-btn" id="btnScanImage" disabled>ANALISAR LOGOTIPO</button> </div> <div id="scanLogs" ></div> </div> </div> </div> <script> const logs=document.getElementById('scanLogs');
                const input=document.getElementById('brandInput');
                let currentMode='text';

                function setMode(mode) {
                    currentMode=mode;
                    document.getElementById('btnText').className=mode==='text' ? 'mode-btn active': 'mode-btn';
                    document.getElementById('btnImage').className=mode==='image' ? 'mode-btn active': 'mode-btn';

                    document.getElementById('textInputArea').style.display=mode==='text' ? 'flex': 'none';
                    document.getElementById('imageInputArea').style.display=mode==='image' ? 'flex': 'none';

                    if(mode==='text') input.focus();
                }

                function handleImageSelect(input) {
                    const file=input.files[0];

                    if (file) {
                        document.getElementById('fileName').innerText=file.name;
                        document.getElementById('btnScanImage').disabled=false;

                        const reader=new FileReader();

                        reader.onload=function(e) {
                            document.getElementById('previewObj').src=e.target.result;
                            document.getElementById('imgPreview').style.display='block';
                        }

                        reader.readAsDataURL(file);
                    }
                }

                input.addEventListener('keypress', function (e) {
                        if (e.key==='Enter') startScan();
                    });

                async function startScanImage() {
                    // Varredura Visual REAL (pHash)
                    const logsDiv=document.getElementById('scanLogs');
                    logsDiv.innerHTML='';

                    const fileInput=document.getElementById('logoUpload');
                    const file=fileInput.files[0];

                    if ( !file) {
                        log('Erro: Nenhuma imagem selecionada.', 'danger');
                        return;
                    }

                    // Bloquear inputs
                    document.getElementById('btnScanImage').disabled=true;
                    document.getElementById('logoUpload').disabled=true;

                    log(`> Uploading $ {
                            Math.round(file.size/1024)
                        }

                        KB para Cloud Neural Engine...`, 'info');
                    await wait(600);
                    log(`[âœ“] Imagem recebida. Iniciando Analise de Hashing Perceptivo (pHash)...`, 'success');


                    try {
                        const formData=new FormData();
                        formData.append('image', file);

                        log('> Computando assinaturas visuais e comparando com banco de dados...', 'info');

                        const response=await fetch('/api/scan-live/image', {
                            method: 'POST',
                            body: formData
                        });
                    const data=await response.json();

                    if(data.status==='success') {
                        log(`[âœ“] Varredura Visual Concluida.`, 'success');
                        log(`----------------------------------------`, 'info');

                        if(data.count > 0) {
                            log(`[ !] CRITICO: $ {
                                    data.count
                                }

                                Marcas Similares Detectadas no Banco de Dados !`, 'danger');

                            data.matches.forEach(m=> {
                                    let icon=m.similarity > 90 ? 'ðŸ”¥' : 'âš ï¸';

                                    log(` -> $ {
                                            icon
                                        }

                                        [$ {
                                            m.similarity
                                        }

                                        % Match] $ {
                                            m.brand_name
                                        }

                                        `, 'warning');

                                    log(` Titular: $ {
                                            m.owner
                                        }

                                        | Status: $ {
                                            m.status
                                        }

                                        `, 'danger');
                                });
                            // Teaser
                            log(`\n[ðŸ”’] Relatorio Visual Completo Bloqueado. Faca login para ver as imagens lado a lado.`, 'info');
                        }

                        else {
                            log(`[âœ“] Nenhuma marca visualmente similar encontrada (Clean Match).`, 'success');
                        }

                    }

                    else {
                        log(`[ERRO] Falha no processamento: $ {
                                data.details
                            }

                            `, 'danger');
                    }

                }

                catch (e) {
                    log(`[ERRO DE CONEXAO] $ {
                            e
                        }

                        `, 'danger');
                }

                // Reabilitar
                document.getElementById('btnScanImage').disabled=false;
                document.getElementById('logoUpload').disabled=false;
            }

            async function startScan() {
                const term=input.value.trim();
                if ( !term) return;

                // Limpar e bloquear
                logs.innerHTML='';
                input.disabled=true;
                document.querySelector('.scan-btn').disabled=true;

                log(`> Iniciando protocolo de varredura para: "${term}" ...`, 'info');
                await wait(500);

                log(`> Resolvendo DNS global...`, 'info');

                try {
                    const response=await fetch('/api/scan-live', {

                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }

                        ,
                        body: JSON.stringify({
                            term: term
                        })
                });
            const data=await response.json();

            // === LÃ“GICA DE DADOS RESTRITOS (FREEMIUM) ===

            // 1. Base de Dados Interna
            log(`> Consultando Base de Dados m24 Local...`, 'info');
            await wait(600);

            if (data.restricted && data.counts.local > 0) {
                log(`[ !] DETECTADO: $ {
                        data.counts.local
                    }

                    CONFLITO(S) INTERNO(S).`, 'danger');
                log(`[ðŸ”’] Detalhes ocultos para visitantes.`, 'warning');
            }

            else if (data.local && data.local.length > 0) {
                log(`[ !] ALERTA: $ {
                        data.local.length
                    }

                    registro(s) interno(s) similar(es) encontrado(s):`, 'danger');

                data.local.forEach(l=> {
                        log(` -> $ {
                                l.name
                            }

                            ($ {
                                    l.status

                                }) | Titular: $ {
                                l.owner
                            }

                            `, 'warning');
                    });
            }

            else {
                log(`[âœ“] Nenhum conflito interno detectado.`, 'success');
            }

            // 1.5 Base Oficial BPI (IPI) -- REAL --
            log(`> Consultando Boletim de Propriedade Industrial (BPI Oficial)...`, 'info');
            await wait(800);

            if (data.restricted && data.counts.bpi > 0) {
                log(`[ !] CRITICO: $ {
                        data.counts.bpi
                    }

                    REGISTRO(S) NO INPI/BPI ENCONTRADOS.`, 'danger');
                log(`[ðŸ”’] Detalhes oficiais ocultos para visitantes.`, 'warning');
            }

            else if (data.bpi && data.bpi.length > 0) {
                log(`[ !] ALERTA OFICIAL: $ {
                        data.bpi.length
                    }

                    registro(s) no BPI detectado(s):`, 'danger');

                data.bpi.forEach(b=> {
                        // FormataÃ§Ã£o compacta para terminal
                        let statusIcon=b.status==='caducidade' ? '[â€ ]' : '[R]';

                        log(` -> $ {
                                statusIcon
                            }

                            Proc: $ {
                                b.process
                            }

                            | $ {
                                b.brand
                            }

                            ($ {
                                    b.status
                                })`, 'danger');

                        log(` Titular: $ {
                                b.applicant.substring(0, 30)
                            }

                            ...`, 'warning');
                    });
            }

            else {
                log(`[âœ“] Limpo no BPI (Nenhuma coincidencia direta).`, 'success');
            }

            // 2. DomÃ­nios e VariaÃ§Ãµes
            log(`> Inteligencia Web: Buscando variacoes e dominios...`, 'info');
            await wait(800);

            if (data.restricted && data.counts.domains > 0) {
                log(`[ !] ALERTA: $ {
                        data.counts.domains
                    }

                    SITES OU VARIACOES ENCONTRADAS NA WEB.`, 'danger');
                log(`[ðŸ”’] Deseja ver quais sao? Faca Login.`, 'warning');
            }

            else {
                let foundDomains=0;

                data.domains.forEach(d=> {
                        if (d.status==='occupied') {
                            foundDomains++;

                            log(`[WEB] Site Encontrado: $ {
                                    d.domain
                                }

                                `, 'warning');
                        }

                        else if (d.domain.startsWith (term)) {
                            log(`[WEB] DisponÃ­vel: $ {
                                    d.domain
                                }

                                `, 'success');
                        }
                    });
                if (foundDomains===0) log(`[âœ“] Web Limpa (DomÃ­nios principais livres)`, 'success');
            }

            await wait(1000);
            log(`> Rastreador Social & MÃ­dia...`, 'info');

            // 3. Redes Sociais
            if (data.restricted && data.counts.social > 0) {
                log(`[ !] ALERTA: $ {
                        data.counts.social
                    }

                    REDES SOCIAIS EM USO.`, 'danger');
            }

            else {
                data.social.forEach(s=> {
                        if (s.status==='occupied') {
                            log(`[X] $ {
                                    s.network
                                }

                                : EM USO ($ {
                                        s.url
                                    })`, 'danger');
                        }

                        else if (s.status==='available') {
                            log(`[âœ“] $ {
                                    s.network
                                }

                                : DISPONÃVEL`, 'success');
                        }

                        else {
                            log(`[?] $ {
                                    s.network
                                }

                                : STATUS DESCONHECIDO (Protegido)`, 'info');
                        }
                    });
            }


            await wait(500);
            log(`----------------------------------------`, 'info');

            if (data.restricted && (data.counts.local > 0 || data.counts.domains > 0 || data.counts.social > 0)) {
                log(`[ðŸ”’] RESULTADO BLOQUEADO`, 'danger');
                log(`Foram encontrados potenciais conflitos de marca.`, 'warning');
                log(`Crie uma conta para ver o relatÃ³rio completo de riscos.`, 'info');

                // Adicionar BotÃ£o de Cadastro
                const timeline=document.getElementById('scanLogs');
                const cta=document.createElement('div');
                cta.innerHTML=`<br><div style="text-align:center;"><a href="/signup" style="background: #ef4444; color: white; padding: 12px 24px; text-decoration: none; font-weight: bold; border-radius: 6px; display:inline-block; border: 1px solid #ef4444;">ðŸš¨ PROTEGER MINHA MARCA AGORA (VER DETALHES)</a></div><br>`;
                timeline.appendChild(cta);

            }

            else {
                log(`> Varredura m24 concluÃ­da.`, 'success');
            }

        }

        catch (error) {
            log(`[ERRO CRÃTICO] Falha na conexÃ£o com servidor m24: $ {
                    error
                }

                `, 'danger');
        }

        // Reabilitar
        input.disabled=false;
        document.querySelector('.scan-btn').disabled=false;
        if(currentMode==='text') input.focus();
    }

    function log(text, type='info') {
        const div=document.createElement('div');

        div.className=`log-line log-$ {
            type
        }

        `;
        div.innerText=text;
        logs.appendChild(div);

        // Auto scroll
        const termBody=document.querySelector('.terminal-body'); // Corrigido selector
        if(termBody) termBody.scrollTop=termBody.scrollHeight;

        // Scroll container pai tbm se necessario
        const win=document.querySelector('.terminal-window');
        if(win) win.scrollTop=win.scrollHeight;
    }

    function wait(ms) {
        return new Promise(resolve=> setTimeout(resolve, ms));
    }

    </script> {
        % endblock %
    }