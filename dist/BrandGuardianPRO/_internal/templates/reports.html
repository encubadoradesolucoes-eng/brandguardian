{% extends "layout.html" %}

{% block title %}Relatório Global de Inteligência | M24 Brand Guardian{% endblock %}

{% block extra_css %}
<style>
    .report-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 2rem;
        margin-top: 2rem;
    }
    .intelligence-card {
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-2xl);
        padding: 2rem;
    }
    .scan-status {
        padding: 1.5rem;
        border-radius: var(--radius-xl);
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .status-alert { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); }
    .status-ok { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); }
    
    .risk-item {
        padding: 1rem;
        border-bottom: 1px solid var(--border-subtle);
    }
    .recommendation-pill {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 100px;
        font-size: 0.7rem;
        font-weight: 800;
        background: var(--brand-primary);
        color: white;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="animate-reveal">
    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 3rem;">
        <div>
            <h1 class="hero-title">Relatório Global de PI</h1>
            <p class="hero-desc">Consolidado de ativos protegidos vs. riscos detectados na rede.</p>
        </div>
        <div>
            <button onclick="runGlobalScan(this)" class="btn-m24-primary">
                <i class="ri-shield-flash-line"></i> FORÇAR VARREDURA GLOBAL
            </button>
        </div>
    </div>

    <!-- Status da Varredura Coletiva -->
    <div class="scan-status {% if needs_scan %}status-alert{% else %}status-ok{% endif %}">
        <div style="display: flex; gap: 20px; align-items: center;">
            <div style="font-size: 2rem; color: {% if needs_scan %}#ef4444{% else %}#22c55e{% endif %};">
                <i class="ri-time-line"></i>
            </div>
            <div>
                <div style="font-weight: 800; color: var(--text-vibrant);">
                    {% if needs_scan %}Varredura Manual Recomendada{% else %}Monitoramento Atualizado{% endif %}
                </div>
                <div style="font-size: 0.85rem; color: var(--text-dim);">Última análise completa realizada em: <strong>{{ last_scan }}</strong></div>
            </div>
        </div>
        {% if needs_scan %}
        <div style="font-size: 0.8rem; color: #ef4444; font-weight: 700;">PROCESSO RECOMENDADO A CADA 15 DIAS</div>
        {% endif %}
    </div>

    <div class="report-grid">
        <!-- Coluna Esquerda: Estatísticas -->
        <div style="display: flex; flex-direction: column; gap: 2rem;">
            <div class="intelligence-card">
                <h3 style="margin-bottom: 1.5rem;">Resumo de Ativos</h3>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-dim);">Total Protegido</span>
                        <span style="font-weight: 800;">{{ total }} Marcas</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-dim);">Criticamente em Risco</span>
                        <span style="font-weight: 800; color: var(--danger);">{{ high_risk|length }} Casos</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-dim);">Processos em Curso</span>
                        <span style="font-weight: 800; color: var(--brand-accent);">Ativos</span>
                    </div>
                </div>
            </div>

            <div class="intelligence-card" style="border-color: var(--brand-accent);">
                <h3>Recomendações do Gestor</h3>
                <p style="font-size: 0.85rem; color: var(--text-dim); margin: 10px 0 20px 0;">Baseado na análise de 15 dias, sugerimos as seguintes ações estratégicas:</p>
                <ul style="padding-left: 20px; color: var(--text-standard); font-size: 0.9rem;">
                    <li>Notificar Titulares de marcas com risco > 80%</li>
                    <li>Solicitar oposição formal ao IPI para conflitos diretos</li>
                    <li>Validar 21 processos pendentes</li>
                </ul>
            </div>
        </div>

        <!-- Coluna Direita: Detalhes de Conflitos -->
        <div class="intelligence-card">
            <h3 style="margin-bottom: 2rem;">Mapa de Conflitos Críticos (Alvos Prioritários)</h3>
            
            {% if high_risk %}
                {% for b in high_risk %}
                <div class="risk-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 800; color: var(--brand-primary);">{{ b.name }}</div>
                            <div style="font-size: 0.75rem; color: var(--text-dim);">Proprietário: {{ b.owner_name }}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: 900; color: var(--danger);">{{ (b.risk_score)|round(1) }}%</div>
                            <div style="font-size: 0.6rem; text-transform: uppercase;">Nível de Risco</div>
                        </div>
                    </div>
                    <div class="recommendation-pill">Ação Recomendada: Notificar Oposição</div>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 3rem; color: var(--text-dim);">
                    <i class="ri-checkbox-circle-line" style="font-size: 3rem; color: var(--success);"></i>
                    <p>Nenhum conflito crítico detectado atualmente na rede.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function runGlobalScan(btn) {
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> EXECUTANDO ANÁLISE COMPLETA...';
    
    fetch('/api/global_scan', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        openM24Dialog('Relatório Atualizado', data.message, 'ri-file-chart-line', 'var(--success)');
        document.querySelector('#m24-dialog-overlay button').onclick = () => location.reload();
    })
    .catch(err => {
        openM24Dialog('Erro de Análise', 'Não foi possível gerar o relatório global neste momento.', 'ri-error-warning-line', 'var(--danger)');
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}
</script>
{% endblock %}
